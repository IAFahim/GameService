@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using GameService.Ludo
@using GameService.GameCore
@inject GameService.Web.Services.GameAdminService AdminService

<div class="row">
    <!-- Visualization Column -->
    <div class="col-md-8">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }
        
        <div class="row g-3">
            @for (int p = 0; p < 4; p++)
            {
                var playerIdx = p;
                <div class="col-6">
                    <div class="card @(State.CurrentPlayer == playerIdx ? "border-primary border-3" : "")">
                        <div class="card-header @GetColorClass(playerIdx) text-white d-flex justify-content-between">
                            <span>Player @playerIdx</span>
                            @if(State.CurrentPlayer == playerIdx) { <span class="badge bg-light text-dark">Active Turn</span> }
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                @for (int t = 0; t < 4; t++)
                                {
                                    var tokenIdx = t;
                                    int pos = GetTokenPos(playerIdx, tokenIdx);
                                    <div class="text-center border rounded p-2" style="width: 23%;">
                                        <small>Token @tokenIdx</small><br/>
                                        <strong>@FormatPos(pos)</strong>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <div class="alert alert-secondary mt-3 text-center">
            <h3>Dice: @(State.LastDiceRoll == 0 ? "Waiting..." : State.LastDiceRoll)</h3>
        </div>
    </div>

    <!-- Controls Column -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">God Mode Controls</div>
            <div class="card-body">
                <h6>1. Roll Dice</h6>
                <!-- Disable if dice already rolled -->
                <button class="btn btn-warning w-100 mb-3" 
                        @onclick="DoForceRoll" 
                        disabled="@(isBusy || State.LastDiceRoll != 0)">
                    @if (isBusy) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    Force Roll
                </button>
                
                <h6>2. Move Token</h6>
                <div class="d-grid gap-2">
                    @for (int i = 0; i < 4; i++)
                    {
                        var tIdx = i;
                        var isLegal = IsMoveLegal(tIdx);
                        
                        <button class="btn @(isLegal ? "btn-success" : "btn-outline-secondary")" 
                                @onclick="() => DoForceMove(tIdx)"
                                disabled="@(isBusy || !isLegal)">
                            Token @tIdx @(isLegal ? "(Valid)" : "")
                        </button>
                    }
                </div>
                
                <hr />
                <button class="btn btn-secondary w-100" @onclick="DoRefresh" disabled="@isBusy">
                    @if (isBusy) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    Refresh State
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public required string RoomId { get; set; }
    [Parameter] public required LudoStateDto State { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    
    private bool isBusy = false;
    private string? errorMessage;

    private int GetTokenPos(int player, int tokenIdx) 
    {
        var index = (player * 4) + tokenIdx;
        return index < State.Tokens.Length ? State.Tokens[index] : 0;
    }

    private string GetColorClass(int p) => p switch { 0 => "bg-danger", 1 => "bg-success", 2 => "bg-warning text-dark", _ => "bg-primary" };

    private string FormatPos(int pos)
    {
        if (pos == 0) return "Base";
        if (pos == 57) return "Home";
        return pos.ToString();
    }

    private bool IsMoveLegal(int tokenIndex)
    {
        if (State.LastDiceRoll == 0) return false;
        
        // Check if this token can move based on current dice roll
        int currentPos = GetTokenPos(State.CurrentPlayer, tokenIndex);
        
        // Token in base needs 6 to move
        if (currentPos == 0) return State.LastDiceRoll == 6;
        
        // Token at home can't move
        if (currentPos == 57) return false;
        
        // Check if move would exceed home
        return (currentPos + State.LastDiceRoll) <= 57;
    }

    private async Task DoForceRoll()
    {
        isBusy = true;
        errorMessage = null;
        StateHasChanged();
        
        try 
        {
            await AdminService.PlayLudoRollAsync(RoomId);
            await OnRefresh.InvokeAsync();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"API Error: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally 
        { 
            isBusy = false; 
            StateHasChanged();
        }
    }

    private async Task DoForceMove(int tokenIndex)
    {
        isBusy = true;
        errorMessage = null;
        StateHasChanged();
        
        try 
        {
            await AdminService.PlayLudoMoveAsync(RoomId, tokenIndex);
            await OnRefresh.InvokeAsync();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"API Error: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally 
        { 
            isBusy = false; 
            StateHasChanged();
        }
    }
    
    private async Task DoRefresh()
    {
        isBusy = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            await OnRefresh.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }
}