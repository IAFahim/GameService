@page "/games/{RoomId}"
@attribute [Authorize]
@rendermode InteractiveServer
@inject GameAdminService AdminService
@inject NavigationManager Nav
@using System.Text.Json
@using GameService.Ludo
@using GameService.GameCore
@using GameService.Web.Components.Ludo

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="games">Active Games</a></li>
                <li class="breadcrumb-item active" aria-current="page">@RoomId</li>
            </ol>
        </nav>
        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteGame">
            <i class="bi bi-trash"></i> Delete Room
        </button>
    </div>

    @if (isLoading)
    {
        <div class="spinner-border text-primary"></div>
    }
    else if (ludoState != null)
    {
        <!-- RENDER THE VISUAL PANEL FOR LUDO -->
        <LudoAdminPanel RoomId="@RoomId" State="ludoState" OnRefresh="LoadGame" />
    }
    else if (!string.IsNullOrEmpty(rawJson))
    {
        <!-- Fallback for other game types or raw view -->
        <div class="alert alert-warning">
            Visual inspector not available for this game type. Showing raw data.
        </div>
        <pre class="bg-light p-3 border rounded">@rawJson</pre>
    }
    else
    {
        <div class="alert alert-danger">
            Room not found or failed to load.
        </div>
    }
</div>

@code {
    [Parameter] public string RoomId { get; set; } = "";
    
    private bool isLoading = true;
    private string? gameType;
    private string? rawJson;
    private LudoStateDto? ludoState;

    protected override async Task OnInitializedAsync()
    {
        await LoadGame();
    }

    private async Task LoadGame()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            var json = await AdminService.GetGameStateAsync(RoomId);
            if (json.HasValue)
            {
                rawJson = json.Value.GetRawText();
                
                // Check GameType from Meta
                if (json.Value.TryGetProperty("meta", out var metaProp) && 
                    metaProp.TryGetProperty("gameType", out var typeProp))
                {
                    gameType = typeProp.GetString();
                }

                if (string.Equals(gameType, "Ludo", StringComparison.OrdinalIgnoreCase))
                {
                    ludoState = MapToLudoState(json.Value);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load game: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private LudoStateDto? MapToLudoState(JsonElement root)
    {
        try
        {
            if (!root.TryGetProperty("state", out var stateEl))
                return null;

            var tokens = new byte[16];
            if (stateEl.TryGetProperty("tokens", out var tokensProp))
            {
                if (tokensProp.ValueKind == JsonValueKind.Array)
                {
                    int i = 0;
                    foreach (var token in tokensProp.EnumerateArray())
                    {
                        if (i < 16) tokens[i++] = (byte)token.GetInt32();
                    }
                }
                else if (tokensProp.ValueKind == JsonValueKind.String)
                {
                    var tokenBytes = tokensProp.GetBytesFromBase64();
                    Array.Copy(tokenBytes, tokens, Math.Min(tokenBytes.Length, 16));
                }
            }

            return new LudoStateDto
            {
                CurrentPlayer = stateEl.GetProperty("currentPlayer").GetInt32(),
                LastDiceRoll = stateEl.GetProperty("lastDiceRoll").GetInt32(),
                TurnId = stateEl.GetProperty("turnId").GetInt32(),
                Winner = stateEl.GetProperty("winner").GetInt32(),
                ActiveSeatsBinary = stateEl.TryGetProperty("activeSeatsBinary", out var asb) 
                    ? asb.GetString() ?? "0000" 
                    : "0000",
                Tokens = tokens,
                ConsecutiveSixes = stateEl.TryGetProperty("consecutiveSixes", out var cs) 
                    ? cs.GetInt32() 
                    : 0
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ludo state mapping failed: {ex}");
            return null;
        }
    }
    
    private async Task DeleteGame()
    {
        await AdminService.DeleteGameAsync(RoomId);
        Nav.NavigateTo("games");
    }
}
