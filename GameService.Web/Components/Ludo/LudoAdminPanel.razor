@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using GameService.Ludo
@using GameService.GameCore
@inject GameService.Web.Services.GameAdminService AdminService

<div class="row g-4">
    <!-- Game State Visualization -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-secondary"><i class="bi bi-grid-3x3 me-2"></i>Board State</h5>
                <div>
                    @if (State.Winner != -1)
                    {
                        <span class="badge bg-warning text-dark fs-6 animate-pulse">
                            <i class="bi bi-trophy-fill me-1"></i> Player @State.Winner Wins!
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-light text-secondary border">Turn ID: @State.TurnId</span>
                    }
                </div>
            </div>
            <div class="card-body bg-light">
                
                <!-- Dice Area -->
                <div class="text-center mb-4 py-3 bg-white rounded shadow-sm">
                    <div class="text-uppercase small text-muted mb-2 fw-bold tracking-wider">Current Action</div>
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <div class="d-flex flex-column align-items-center">
                            <span class="badge @GetPlayerBadgeClass(State.CurrentPlayer) mb-2">Player @State.CurrentPlayer's Turn</span>
                        </div>
                        <div class="vr"></div>
                        <div class="d-flex align-items-center">
                            <span class="display-6 fw-bold me-2">Dice:</span>
                            @if (State.LastDiceRoll > 0)
                            {
                                <div class="dice-box bounce-in">@State.LastDiceRoll</div>
                            }
                            else
                            {
                                <span class="text-muted fst-italic">Waiting for roll...</span>
                            }
                        </div>
                    </div>
                </div>

                <!-- Player Tracks -->
                <div class="d-flex flex-column gap-3">
                    @for (int p = 0; p < 4; p++)
                    {
                        var playerIdx = p;
                        bool isTurn = State.CurrentPlayer == playerIdx;
                        bool isActive = IsSeatActive(playerIdx);

                        <div class="player-track-card bg-white rounded border @(isTurn ? "border-primary border-2 shadow-sm" : "") p-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="badge-circle me-2 @GetPlayerBgClass(playerIdx)">P@(playerIdx)</div>
                                <div class="fw-bold flex-grow-1 @(!isActive ? "text-muted" : "")">
                                    Player @playerIdx
                                    @if (!isActive) { <small>(Empty)</small> }
                                </div>
                                @if (isTurn) { <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div> }
                            </div>
                            
                            <!-- Token Progress Bars -->
                            <div class="row g-2">
                                @for (int t = 0; t < 4; t++)
                                {
                                    var tokenIdx = t;
                                    var pos = GetTokenPos(playerIdx, tokenIdx);
                                    var progress = GetProgressPercent(pos);
                                    var isMovable = IsMoveLegal(playerIdx, tokenIdx);
                                    
                                    <div class="col-3">
                                        <div class="token-lane position-relative" style="cursor: default" title="Pos: @pos">
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar @GetPlayerBgClass(playerIdx)" role="progressbar" 
                                                     style="width: @progress%"></div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1" style="font-size: 0.7rem;">
                                                <span class="fw-bold text-muted">T@(tokenIdx)</span>
                                                @if (pos == 0) { <span class="badge bg-secondary" style="font-size:0.6em">BASE</span> }
                                                else if (pos == 57) { <span class="badge bg-success" style="font-size:0.6em">HOME</span> }
                                                else { <span>@pos</span> }
                                            </div>
                                            
                                            <!-- Valid Move Indicator overlay -->
                                            @if (isMovable)
                                            {
                                                <div class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle">
                                                    <span class="visually-hidden">Legal Move</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Controls Column -->
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-dark text-white py-3">
                <h5 class="mb-0"><i class="bi bi-controller me-2"></i>God Mode</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show small" role="alert">
                        @errorMessage
                        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                    </div>
                }

                <div class="mb-4">
                    <label class="form-label text-uppercase small fw-bold text-muted">Phase 1: Roll</label>
                    <button class="btn btn-primary w-100 py-2 shadow-sm" 
                            @onclick="DoForceRoll" 
                            disabled="@(isBusy || State.LastDiceRoll != 0 || State.Winner != -1)">
                        @if (isBusy && State.LastDiceRoll == 0) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        <i class="bi bi-dice-6-fill me-2"></i>Force Roll
                    </button>
                </div>
                
                <hr class="text-muted opacity-25" />

                <div class="mb-4">
                    <label class="form-label text-uppercase small fw-bold text-muted">Phase 2: Move Token</label>
                    <div class="d-grid gap-2">
                        @for (int i = 0; i < 4; i++)
                        {
                            var tIdx = i;
                            var isLegal = IsMoveLegal(State.CurrentPlayer, tIdx);
                            
                            <button class="btn @(isLegal ? "btn-success" : "btn-outline-secondary") d-flex justify-content-between align-items-center" 
                                    @onclick="() => DoForceMove(tIdx)"
                                    disabled="@(isBusy || !isLegal)">
                                <span>Move Token @tIdx</span>
                                @if (isLegal) { <i class="bi bi-check-circle-fill"></i> }
                            </button>
                        }
                    </div>
                    @if (State.LastDiceRoll > 0 && !HasAnyLegalMove())
                    {
                        <div class="alert alert-warning mt-2 small text-center">
                            No legal moves available.
                        </div>
                    }
                </div>
                
                <div class="mt-auto pt-3 border-top">
                    <button class="btn btn-light w-100 text-muted" @onclick="DoRefresh" disabled="@isBusy">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh State
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-circle { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
    .dice-box { width: 40px; height: 40px; background: #333; color: white; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .bounce-in { animation: bounce 0.5s; }
    @@keyframes bounce { 0% { transform: scale(0.1); opacity: 0;} 60% { transform: scale(1.2); opacity: 1;} 100% { transform: scale(1); } }
</style>

@code {
    [Parameter] public required string RoomId { get; set; }
    [Parameter] public required LudoStateDto State { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    
    private bool isBusy = false;
    private string? errorMessage;

    private int GetTokenPos(int player, int tokenIdx) 
    {
        var index = (player * 4) + tokenIdx;
        return index < State.Tokens.Length ? State.Tokens[index] : 0;
    }

    private double GetProgressPercent(int pos)
    {
        if (pos == 0) return 0; // Base
        if (pos >= 57) return 100; // Home
        return (pos / 57.0) * 100;
    }

    private string GetPlayerBgClass(int p) => p switch { 0 => "bg-danger", 1 => "bg-success", 2 => "bg-warning", _ => "bg-primary" };
    private string GetPlayerBadgeClass(int p) => p switch { 0 => "bg-danger-subtle text-danger", 1 => "bg-success-subtle text-success", 2 => "bg-warning-subtle text-dark", _ => "bg-primary-subtle text-primary" };

    private bool IsSeatActive(int p)
    {
        // Convert binary string back to check bit
        if (string.IsNullOrEmpty(State.ActiveSeatsBinary)) return false;
        // String is like "1111" or "0101". It's padded left.
        // P0 is LSB (last char), P3 is MSB (first char)
        // Actually LudoCore uses `(ActiveSeats & (1 << CurrentPlayer))`
        // We need to parse the integer from the string or rely on binary string indexing
        try 
        {
            var activeMask = Convert.ToInt32(State.ActiveSeatsBinary, 2);
            return (activeMask & (1 << p)) != 0;
        }
        catch { return false; }
    }

    private bool IsMoveLegal(int player, int tokenIndex)
    {
        if (State.LastDiceRoll == 0 || State.CurrentPlayer != player) return false;
        
        int currentPos = GetTokenPos(player, tokenIndex);
        
        // Rules logic (Simplified for UI display)
        if (currentPos == 0) return State.LastDiceRoll == 6; // Need 6 to exit base
        if (currentPos == 57) return false; // Already home
        return (currentPos + State.LastDiceRoll) <= 57; // Can't overshoot home
    }

    private bool HasAnyLegalMove()
    {
        for(int i=0; i<4; i++) if (IsMoveLegal(State.CurrentPlayer, i)) return true;
        return false;
    }

    // Actions
    private async Task DoForceRoll()
    {
        await ExecuteSafe(async () => await AdminService.PlayLudoRollAsync(RoomId));
    }

    private async Task DoForceMove(int tokenIndex)
    {
        await ExecuteSafe(async () => await AdminService.PlayLudoMoveAsync(RoomId, tokenIndex));
    }
    
    private async Task DoRefresh()
    {
        await ExecuteSafe(async () => await Task.CompletedTask); // Just triggers finally block refresh
    }

    private async Task ExecuteSafe(Func<Task> action)
    {
        isBusy = true;
        errorMessage = null;
        StateHasChanged();
        try 
        {
            await action();
            await OnRefresh.InvokeAsync();
        }
        catch (HttpRequestException ex) { errorMessage = $"Network Error: {ex.Message}"; }
        catch (Exception ex) { errorMessage = $"Error: {ex.Message}"; }
        finally { isBusy = false; StateHasChanged(); }
    }
}