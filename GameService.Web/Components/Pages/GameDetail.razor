@page "/games/{RoomId}"
@using System.Text.Json
@using GameService.LuckyMine
@using GameService.Web.Components.LuckyMine
@using GameService.Web.Components.Ludo
@attribute [Authorize]
@rendermode InteractiveServer
@inject GameAdminService AdminService
@inject NavigationManager Nav

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="games">Active Games</a></li>
                <li class="breadcrumb-item active" aria-current="page">@RoomId</li>
            </ol>
        </nav>
        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteGame">
            <i class="bi bi-trash"></i> Delete Room
        </button>
    </div>

    @if (isLoading)
    {
        <div class="spinner-border text-primary"></div>
    }
    else if (ludoState != null)
    {
        <!-- Header Info -->
        <div class="alert @(ludoState.IsGameOver ? "alert-success" : "alert-info")">
            @if (ludoState.IsGameOver)
            {
                <h4><i class="bi bi-trophy-fill me-2"></i>Game Over!</h4>
            }
            else
            {
                <h4>Current Turn: Player @ludoState.CurrentPlayer</h4>
                <div class="d-flex gap-3">
                    <span><i class="bi bi-dice-6 me-1"></i>Last Roll: @(ludoState.LastDiceRoll == 0 ? "-" : ludoState.LastDiceRoll)</span>
                    <span><i class="bi bi-clock-history me-1"></i>Turn ID: @ludoState.TurnId</span>
                </div>
            }
        </div>

        <LudoAdminPanel RoomId="@RoomId" State="ludoState" OnRefresh="LoadGame"/>
    }
    else if (luckyMineState != null)
    {
        <div class="alert @(luckyMineState.Status == "Active" ? "alert-info" : "alert-warning")">
            Status: <strong>@luckyMineState.Status</strong> | 
            Mines: @luckyMineState.RemainingMines / @luckyMineState.TotalTiles
        </div>
        
        <LuckyMineAdminPanel Dto="luckyMineState"/>
    }
    else if (!string.IsNullOrEmpty(rawJson))
    {
        <div class="alert alert-warning">
            Visual inspector not available for this game type. Showing raw data.
        </div>
        <pre class="bg-light p-3 border rounded">@rawJson</pre>
    }
    else
    {
        <div class="alert alert-danger">
            Room not found or failed to load.
        </div>
    }
</div>

@code {
    [Parameter] public string RoomId { get; set; } = "";

    private bool isLoading = true;
    private string? gameType;
    private string? rawJson;
    private LudoStateDto? ludoState;
    private LuckyMineFullDto? luckyMineState;

    protected override async Task OnInitializedAsync()
    {
        await LoadGame();
    }

    private async Task LoadGame()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var json = await AdminService.GetGameStateAsync(RoomId);
            if (json.HasValue)
            {
                if (json.Value.TryGetProperty("meta", out var metaProp) &&
                    metaProp.TryGetProperty("gameType", out var typeProp))
                {
                    gameType = typeProp.GetString();
                }

                if (string.Equals(gameType, "Ludo", StringComparison.OrdinalIgnoreCase))
                {
                    ludoState = MapToLudoState(json.Value);
                }
                else if (string.Equals(gameType, "LuckyMine", StringComparison.OrdinalIgnoreCase))
                {
                    var fullStateJson = await AdminService.GetLuckyMineFullStateAsync(RoomId);
                    if (fullStateJson.HasValue)
                    {
                        luckyMineState = JsonSerializer.Deserialize<LuckyMineFullDto>(
                            fullStateJson.Value.GetRawText(),
                            new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    }
                }
                else
                {
                    rawJson = json.Value.GetRawText();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load game: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private LudoStateDto? MapToLudoState(JsonElement root)
    {
        try
        {
            if (!root.TryGetProperty("state", out var stateEl))
                return null;

            // Handle byte[] tokens (Base64 string in JSON)
            var tokens = new byte[16];
            if (stateEl.TryGetProperty("tokens", out var tokensProp))
            {
                if (tokensProp.ValueKind == JsonValueKind.String)
                {
                    var tokenBytes = tokensProp.GetBytesFromBase64();
                    Array.Copy(tokenBytes, tokens, Math.Min(tokenBytes.Length, 16));
                }
                else if (tokensProp.ValueKind == JsonValueKind.Array)
                {
                    var i = 0;
                    foreach (var token in tokensProp.EnumerateArray())
                    {
                        if (i < 16) tokens[i++] = token.GetByte();
                    }
                }
            }

            return new LudoStateDto
            {
                CurrentPlayer = stateEl.GetProperty("currentPlayer").GetInt32(),
                LastDiceRoll = stateEl.GetProperty("lastDiceRoll").GetInt32(),
                TurnId = stateEl.GetProperty("turnId").GetInt32(),
                ConsecutiveSixes = stateEl.TryGetProperty("consecutiveSixes", out var cs) ? cs.GetInt32() : 0,
                IsGameOver = stateEl.TryGetProperty("isGameOver", out var igo) && igo.GetBoolean(),
                
                // Optimized Fields
                ActiveSeatsMask = stateEl.TryGetProperty("activeSeatsMask", out var asm) ? asm.GetByte() : (byte)0,
                FinishedMask = stateEl.TryGetProperty("finishedMask", out var fm) ? fm.GetByte() : (byte)0,
                LegalMovesMask = stateEl.TryGetProperty("legalMovesMask", out var lmm) ? lmm.GetByte() : (byte)0,
                WinnersPacked = stateEl.TryGetProperty("winnersPacked", out var wp) ? wp.GetUInt32() : 0,
                
                Tokens = tokens,
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ludo state mapping failed: {ex}");
            return null;
        }
    }

    private async Task DeleteGame()
    {
        await AdminService.DeleteGameAsync(RoomId);
        Nav.NavigateTo("games");
    }
}