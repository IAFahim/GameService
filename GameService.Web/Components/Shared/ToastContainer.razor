@inject ToastService ToastService
@implements IDisposable

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    @foreach (var toast in toasts)
    {
        <div class="toast show align-items-center text-white bg-@GetBgClass(toast.Level) border-0 mb-2 animate-slide-in"
             role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="@GetIcon(toast.Level) me-2"></i>
                    <strong>@toast.Title:</strong> @toast.Message
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        @onclick="() => Remove(toast)"></button>
            </div>
        </div>
    }
</div>

<style>
    .animate-slide-in {
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

@code {
    private readonly List<ToastMessage> toasts = new();
    private CancellationTokenSource _cts = new();
    private bool _disposed;

    protected override void OnInitialized()
    {
        ToastService.OnShow += ShowToast;
    }

    private void ShowToast(string title, string message, ToastLevel level)
    {
        if (_disposed) return;
        
        var toast = new ToastMessage { Title = title, Message = message, Level = level };
        toasts.Add(toast);
        StateHasChanged();

        var token = _cts.Token;
        _ = Task.Delay(4000, token).ContinueWith(_ => 
        { 
            if (!_disposed)
            {
                InvokeAsync(() => Remove(toast)); 
            }
        }, TaskContinuationOptions.NotOnCanceled);
    }

    private void Remove(ToastMessage toast)
    {
        if (_disposed) return;
        toasts.Remove(toast);
        StateHasChanged();
    }

    public void Dispose()
    {
        _disposed = true;
        _cts.Cancel();
        _cts.Dispose();
        ToastService.OnShow -= ShowToast;
    }

    private string GetBgClass(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "success",
            ToastLevel.Error => "danger",
            ToastLevel.Warning => "warning",
            ToastLevel.Info => "info",
            _ => "secondary"
        };
    }

    private string GetIcon(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "bi bi-check-circle-fill",
            ToastLevel.Error => "bi bi-exclamation-octagon-fill",
            ToastLevel.Warning => "bi bi-exclamation-triangle-fill",
            ToastLevel.Info => "bi bi-info-circle-fill",
            _ => "bi bi-bell-fill"
        };
    }

    private class ToastMessage
    {
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public ToastLevel Level { get; set; }
    }

}
