@page "/economy-settings"
@using GameService.ServiceDefaults.Data
@using System.Text.Json
@using GameService.Web.Components.Admin
@attribute [Authorize]
@rendermode InteractiveServer
@inject GameAdminService AdminService
@inject ToastService Toast
@inject ILogger<EconomySettings> Logger
@inject NavigationManager Nav

<PageTitle>Economy Settings</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 fw-bold">Economy Settings</h1>
            <p class="text-muted small mb-0">Manage global economy, rewards, and game fees</p>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link @(activeTab == "global" ? "active" : "")" @onclick="@(() => activeTab = "global")">Global Settings</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(activeTab == "games" ? "active" : "")" @onclick="@(() => activeTab = "games")">Per-Game Settings</button>
        </li>
    </ul>

    @if (activeTab == "global")
    {
        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
            </div>
        }
        else
        {
            <div class="row g-4">
                <!-- Global Settings -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-globe-americas text-primary fs-4"></i>
                                <h5 class="mb-0 fw-bold">Global Configuration</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-end">
                                <div class="col-md-6">
                                    <label for="initialCoins" class="form-label fw-bold">Initial Player Coins</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-coin text-warning"></i></span>
                                        <input type="number" class="form-control" id="initialCoins" 
                                               value="@initialCoins" 
                                               @onchange="@(e => UpdateLongSetting("Economy:InitialCoins", e.Value?.ToString()))">
                                    </div>
                                    <div class="form-text">Amount of coins given to new players upon registration.</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-light border mb-0 d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill text-info me-3 fs-4"></i>
                                        <div>
                                            <strong>Game Entry Fees</strong> are configured per-template.
                                            <a href="templates" class="alert-link">Manage Templates</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Login Settings -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-calendar-check text-success fs-4"></i>
                                <h5 class="mb-0 fw-bold">Daily Login Reward (Global)</h5>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dailyLoginEnabled" 
                                       checked="@dailyLoginEnabled" 
                                       @onchange="@(e => UpdateBoolSetting("Economy:DailyLoginEnabled", (bool)e.Value!))">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="dailyLoginReward" class="form-label fw-bold">Base Reward Amount</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-success-subtle text-success border-success-subtle"><i class="bi bi-gift-fill"></i></span>
                                    <input type="number" class="form-control border-success-subtle" id="dailyLoginReward" 
                                           value="@dailyLoginReward" 
                                           @onchange="@(e => UpdateLongSetting("Economy:DailyLoginReward", e.Value?.ToString()))">
                                    <span class="input-group-text bg-success-subtle text-success border-success-subtle">Coins</span>
                                </div>
                                <div class="form-text">Fixed amount awarded once every 24 hours.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Spin Settings -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-arrow-repeat text-warning fs-4"></i>
                                <h5 class="mb-0 fw-bold">Daily Spin Wheel (Global)</h5>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dailySpinEnabled" 
                                       checked="@dailySpinEnabled" 
                                       @onchange="@(e => UpdateBoolSetting("Economy:DailySpinEnabled", (bool)e.Value!))">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Visualizer -->
                                <div class="col-md-4 d-flex flex-column align-items-center justify-content-center border-end">
                                    <div class="wheel-preview mb-3" style="@GetConicGradient()"></div>
                                    <div class="small text-muted text-center">
                                        Total Weight: <strong>@spinRewards.Sum(r => r.Weight)</strong>
                                    </div>
                                </div>
                                
                                <!-- Editor -->
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-bold mb-0">Segments</label>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="AddSpinSegment">
                                            <i class="bi bi-plus-lg"></i> Add
                                        </button>
                                    </div>
                                    
                                    <div class="spin-segments-list" style="max-height: 300px; overflow-y: auto;">
                                        @if (spinRewards.Count == 0)
                                        {
                                            <div class="text-center text-muted py-3 small">No segments defined.</div>
                                        }
                                        else 
                                        {
                                            @for (int i = 0; i < spinRewards.Count; i++)
                                            {
                                                var index = i;
                                                var item = spinRewards[i];
                                                var percent = GetPercentage(item.Weight);
                                                
                                                <div class="input-group input-group-sm mb-2">
                                                    <span class="input-group-text" style="width: 60px;">@percent%</span>
                                                    <input type="number" class="form-control" placeholder="Amount" 
                                                           value="@item.Amount" 
                                                           @onchange="@(e => UpdateSegmentAmount(index, e.Value))">
                                                    <span class="input-group-text">Coins</span>
                                                    <input type="number" class="form-control" placeholder="Weight" 
                                                           value="@item.Weight" 
                                                           @onchange="@(e => UpdateSegmentWeight(index, e.Value))">
                                                    <button class="btn btn-outline-danger" @onclick="() => RemoveSpinSegment(index)">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            }
                                        }
                                    </div>
                                    
                                    <div class="mt-3 text-end">
                                        <button class="btn btn-primary btn-sm" @onclick="SaveSpinRewards">
                                            <i class="bi bi-save me-2"></i>Save Config
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else if (activeTab == "games")
    {
        <PerGameSettings />
    }
</div>

<style>
    .wheel-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid #eee;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    .spin-segments-list::-webkit-scrollbar {
        width: 6px;
    }
    .spin-segments-list::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 3px;
    }
</style>

@code {
    private string activeTab = "global";
    private bool isLoading = true;
    private List<GlobalSetting> settings = new();

    private long initialCoins;
    
    private bool dailyLoginEnabled;
    private long dailyLoginReward;
    
    private bool dailySpinEnabled;
    private List<SpinRewardItem> spinRewards = new();

    public class SpinRewardItem
    {
        public long Amount { get; set; }
        public int Weight { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            isLoading = true;
            settings = await AdminService.GetSettingsAsync();
            
            var globalConfig = await AdminService.GetGlobalEconomyConfigAsync();
            initialCoins = globalConfig.InitialCoins;
            
            dailyLoginEnabled = GetBool("Economy:DailyLoginEnabled");
            dailyLoginReward = GetLong("Economy:DailyLoginReward", 100);
            
            dailySpinEnabled = GetBool("Economy:DailySpinEnabled");
            var spinJson = GetString("Economy:DailySpinRewards", "[]");
            
            try 
            {
                spinRewards = JsonSerializer.Deserialize<List<SpinRewardItem>>(spinJson) ?? new();
            }
            catch 
            { 
                spinRewards = new();
            }
            
            if (spinRewards.Count == 0)
            {
                // Defaults
                spinRewards.Add(new SpinRewardItem { Amount = 50, Weight = 50 });
                spinRewards.Add(new SpinRewardItem { Amount = 100, Weight = 30 });
                spinRewards.Add(new SpinRewardItem { Amount = 500, Weight = 10 });
                spinRewards.Add(new SpinRewardItem { Amount = 1000, Weight = 1 });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load settings");
            Toast.ShowError("Failed to load settings");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetString(string key, string defaultValue)
    {
        return settings.FirstOrDefault(s => s.Key == key)?.Value ?? defaultValue;
    }

    private bool GetBool(string key)
    {
        var val = GetString(key, "false");
        return val.Equals("true", StringComparison.OrdinalIgnoreCase);
    }

    private long GetLong(string key, long defaultValue)
    {
        var val = GetString(key, defaultValue.ToString());
        return long.TryParse(val, out var res) ? res : defaultValue;
    }

    private async Task UpdateBoolSetting(string key, bool value)
    {
        await UpdateSetting(key, value ? "true" : "false");
        if (key == "Economy:DailyLoginEnabled") dailyLoginEnabled = value;
        if (key == "Economy:DailySpinEnabled") dailySpinEnabled = value;
    }

    private async Task UpdateLongSetting(string key, string? value)
    {
        if (long.TryParse(value, out var res))
        {
            await UpdateSetting(key, res.ToString());
            if (key == "Economy:DailyLoginReward") dailyLoginReward = res;
            if (key == "Economy:InitialCoins") initialCoins = res;
        }
    }

    private void AddSpinSegment()
    {
        spinRewards.Add(new SpinRewardItem { Amount = 100, Weight = 10 });
    }

    private void RemoveSpinSegment(int index)
    {
        if (index >= 0 && index < spinRewards.Count)
        {
            spinRewards.RemoveAt(index);
        }
    }

    private void UpdateSegmentAmount(int index, object? value)
    {
        if (long.TryParse(value?.ToString(), out var val))
        {
            spinRewards[index].Amount = val;
        }
    }

    private void UpdateSegmentWeight(int index, object? value)
    {
        if (int.TryParse(value?.ToString(), out var val))
        {
            spinRewards[index].Weight = Math.Max(1, val);
        }
    }

    private async Task SaveSpinRewards()
    {
        try
        {
            var json = JsonSerializer.Serialize(spinRewards);
            await UpdateSetting("Economy:DailySpinRewards", json);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save spin rewards");
            Toast.ShowError("Failed to save spin config");
        }
    }

    private async Task UpdateSetting(string key, string value)
    {
        try
        {
            await AdminService.UpdateSettingAsync(key, value);
            Toast.ShowSuccess("Setting updated");
            
            var existing = settings.FirstOrDefault(s => s.Key == key);
            if (existing != null)
            {
                existing.Value = value;
            }
            else
            {
                settings.Add(new GlobalSetting { Key = key, Value = value });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update setting {Key}", key);
            Toast.ShowError("Failed to update setting");
        }
    }
    
    private string GetPercentage(int weight)
    {
        var total = spinRewards.Sum(r => r.Weight);
        if (total == 0) return "0";
        return Math.Round((double)weight / total * 100, 1).ToString("0.#");
    }
    
    private string GetConicGradient()
    {
        var total = spinRewards.Sum(r => r.Weight);
        if (total == 0) return "background: #eee";
        
        var parts = new List<string>();
        double current = 0;
        var colors = new[] { "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6610f2", "#0dcaf0" };
        
        for (int i = 0; i < spinRewards.Count; i++)
        {
            var item = spinRewards[i];
            var start = current;
            var end = current + ((double)item.Weight / total * 100);
            var color = colors[i % colors.Length];
            
            parts.Add($"{color} {start}% {end}%");
            current = end;
        }
        
        return $"background: conic-gradient({string.Join(", ", parts)})";
    }
}