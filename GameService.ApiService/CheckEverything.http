@hostname = localhost
@port = 5525
@host = http://{{hostname}}:{{port}}
@contentType = application/json

# ==========================================
# 0. CONFIGURATION & SEEDS
# ==========================================
# NOTE: These are DEVELOPMENT-ONLY values.
# In production, credentials come from environment variables:
# - AdminSettings__ApiKey
# - GameService__AdminSeed__Email
# - GameService__AdminSeed__Password
#
# Generate a secure API key with:
# dotnet run --project GameService.ApiService -- --generate-api-key
# ==========================================

@adminEmail = admin@gameservice.local
@adminPassword = DevAdmin!2024#Secure
@adminApiKey = Dev-Only-Key-ChangeInProd-abc123xyz789!@#$

# Dynamic User Credentials (for testing only)
@userEmail = player_{{$randomInt}}@test.local
@userPassword = TestUser!2024#Pass
@user2Email = player2_{{$randomInt}}@test.local

###
# @name HealthCheck
GET {{host}}/health

# ==========================================
# 1. AUTHENTICATION
# ==========================================

###
# @name LoginAdmin
# 1.1 Authenticate as seeded Admin
POST {{host}}/auth/login
Content-Type: {{contentType}}

{
  "email": "{{adminEmail}}",
  "password": "{{adminPassword}}"
}

> {%
    client.global.set("admin_token", response.body.accessToken);
    client.log("ðŸ‘‘ Admin Token: " + response.body.accessToken);
%}

###
# @name AdminKeyBypass
# 1.2 Test API Key Auth (Service-to-Service bypass)
GET {{host}}/admin/players
X-Admin-Key: {{adminApiKey}}

> {%
    client.test("API Key Auth Success", function () {
        client.assert(response.status === 200, "API Key failed");
    });
%}

###
# @name RegisterUser
# 1.3 Register a new standard player
POST {{host}}/auth/register
Content-Type: {{contentType}}

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}"
}

###
# @name LoginUser
# 1.4 Authenticate as the new player
POST {{host}}/auth/login
Content-Type: {{contentType}}

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}"
}

> {%
    client.global.set("user_token", response.body.accessToken);
    client.log("ðŸ‘¤ User Token: " + response.body.accessToken);
%}

###
# @name LoginFailure
# 1.5 Negative Test: Wrong Password
POST {{host}}/auth/login
Content-Type: {{contentType}}

{
  "email": "{{userEmail}}",
  "password": "WrongPassword!"
}

> {%
    client.test("Login Failed as Expected", function () {
        client.assert(response.status === 401, "Should return 401 Unauthorized");
    });
%}

###

# ==========================================
# 2. PLAYER PROFILE & ECONOMY
# ==========================================

###
# @name GetUserProfile
# 2.1 Get initial state
GET {{host}}/game/me
Authorization: Bearer {{user_token}}

> {%
    client.global.set("user_id", response.body.userId);
    client.global.set("initial_coins", response.body.coins);
%}

###
# @name EarnCoins
# 2.2 Credit coins (Simulate winning)
POST {{host}}/game/coins/transaction
Authorization: Bearer {{user_token}}
Content-Type: {{contentType}}

{
  "amount": 1000,
  "referenceId": "daily_login_bonus",
  "idempotencyKey": "bonus_{{$randomInt}}"
}

> {%
    client.test("Balance Increased", function () {
        client.assert(response.body.newBalance > client.global.get("initial_coins"), "Balance did not update");
    });
    client.global.set("balance_after_earn", response.body.newBalance);
%}

###
# @name IdempotencyCheck
# 2.3 Test Duplicate Transaction (Should fail or return same result)
# We use a fixed idempotency key here to force the collision logic
POST {{host}}/game/coins/transaction
Authorization: Bearer {{user_token}}
Content-Type: {{contentType}}

{
  "amount": 500,
  "referenceId": "duplicate_test",
  "idempotencyKey": "unique_key_12345"
}

###
# @name IdempotencyRetry
# 2.4 Retry same key - should be Conflict (409) or Success with same balance depending on implementation
POST {{host}}/game/coins/transaction
Authorization: Bearer {{user_token}}
Content-Type: {{contentType}}

{
  "amount": 500,
  "referenceId": "duplicate_test",
  "idempotencyKey": "unique_key_12345"
}

> {%
    client.test("Idempotency Catch", function () {
        // Your code returns 409 Conflict for duplicates
        client.assert(response.status === 409, "Should return 409 Conflict for duplicate key");
    });
%}

###
# @name InsufficientFunds
# 2.5 Negative Test: Debit more than available
POST {{host}}/game/coins/transaction
Authorization: Bearer {{user_token}}
Content-Type: {{contentType}}

{
  "amount": -99999999,
  "referenceId": "bad_bet"
}

> {%
    client.test("Insufficient Funds Catch", function () {
        client.assert(response.status === 400 || response.status === 409, "Should return Error");
    });
%}

###
# @name GetTransactionHistory
# 2.6 View Ledger
GET {{host}}/game/coins/history?page=1&pageSize=10
Authorization: Bearer {{user_token}}

# ==========================================
# 3. GAME TEMPLATES (ADMIN)
# ==========================================

###
# @name CreateTemplate
# 3.1 Create a High Stakes Ludo Template
POST {{host}}/admin/templates
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

{
  "name": "High Stakes Ludo (Test)",
  "gameType": "Ludo",
  "maxPlayers": 2,
  "entryFee": 5000,
  "configJson": "{}"
}

> {%
    client.global.set("template_id", response.body);
%}

###
# @name GetTemplates
# 3.2 List all templates
GET {{host}}/admin/templates
Authorization: Bearer {{admin_token}}

# ==========================================
# 4. GAME LIFECYCLE: LUDO
# ==========================================

###
# @name CreateLudoGame
# 4.1 Create game from raw parameters
POST {{host}}/admin/games
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

{
  "gameType": "Ludo",
  "playerCount": 4,
  "entryFee": 100
}

> {%
    client.global.set("ludo_room_id", response.body.roomId);
    client.log("ðŸŽ² Ludo Room: " + response.body.roomId);
%}

###
# @name GetLudoState
# 4.2 Check initial state
GET {{host}}/admin/games/{{ludo_room_id}}
Authorization: Bearer {{admin_token}}

###
# @name LudoAdminRoll
# 4.3 Force a Dice Roll (Admin Override)
POST {{host}}/admin/ludo/{{ludo_room_id}}/roll
Authorization: Bearer {{admin_token}}

> {%
    client.test("Roll Successful", function () {
        client.assert(response.status === 200, "Roll failed");
        client.global.set("dice_value", response.body.newState.lastDiceRoll);
        client.log("ðŸŽ² Rolled: " + response.body.newState.lastDiceRoll);
    });
%}

###
# @name LudoAdminMove
# 4.4 Try to move token 0. 
# Note: This might fail if the token is in base and we didn't roll a 6, 
# but testing the endpoint connectivity is the goal.
POST {{host}}/admin/ludo/{{ludo_room_id}}/move/0
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

###
# @name CreateFromTemplate
# 4.5 Create room using the template we made earlier
POST {{host}}/admin/games/create-from-template
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

{
  "templateId": {{template_id}}
}

> {%
    client.global.set("template_room_id", response.body.roomId);
%}

###

# ==========================================
# 5. GAME LIFECYCLE: LUCKY MINE
# ==========================================

###
# @name CreateLuckyMineGame
# 5.1 Create Mine game
POST {{host}}/admin/games
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

{
  "gameType": "LuckyMine",
  "playerCount": 1,
  "entryFee": 50,
  "configJson": "{\"TotalMines\": 5, \"TotalTiles\": 25}"
}

> {%
    client.global.set("mine_room_id", response.body.roomId);
    client.log("ðŸ’£ LuckyMine Room: " + response.body.roomId);
%}

###
# @name GetLuckyMineState
# 5.2 Get Full State (God Mode - see where mines are)
GET {{host}}/admin/luckymine/{{mine_room_id}}/full-state
Authorization: Bearer {{admin_token}}

> {%
    client.test("Mines Revealed", function () {
        client.assert(response.body.mineMask0 !== undefined, "Mine mask missing");
    });
%}

###

# ==========================================
# 6. ADMIN PLAYER MANAGEMENT
# ==========================================

###
# @name GetAllPlayers
# 6.1 List players
GET {{host}}/admin/players?page=1&pageSize=20
Authorization: Bearer {{admin_token}}

###
# @name AdminAddCoins
# 6.2 Admin manually gives coins to user
POST {{host}}/admin/players/{{user_id}}/coins
Authorization: Bearer {{admin_token}}
Content-Type: {{contentType}}

{
  "amount": 50000
}

###
# @name VerifyAdminCoins
GET {{host}}/game/me
Authorization: Bearer {{user_token}}

> {%
    client.test("Admin Coins Received", function () {
        client.assert(response.body.coins > 50000, "Coins not updated");
    });
%}

###
# @name DeleteUser
# 6.3 Soft delete the test user
DELETE {{host}}/admin/players/{{user_id}}
Authorization: Bearer {{admin_token}}

# ==========================================
# 7. CLEANUP
# ==========================================

###
# @name DeleteLudoGame
DELETE {{host}}/admin/games/{{ludo_room_id}}
Authorization: Bearer {{admin_token}}

###
# @name DeleteTemplateGame
DELETE {{host}}/admin/games/{{template_room_id}}
Authorization: Bearer {{admin_token}}

###
# @name DeleteMineGame
DELETE {{host}}/admin/games/{{mine_room_id}}
Authorization: Bearer {{admin_token}}

###
# @name DeleteTemplate
DELETE {{host}}/admin/templates/{{template_id}}
Authorization: Bearer {{admin_token}}