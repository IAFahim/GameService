@using GameService.Web.Services
@inject GameAdminService AdminService
@inject ToastService Toast

<div class="card mt-3">
    <div class="card-header">
        <h3>Economy Settings for @GameType</h3>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" id="economyTabs-@GameType" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="onboarding-tab-@GameType" data-bs-toggle="tab" data-bs-target="#onboarding-@GameType" type="button" role="tab">Onboarding</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="daily-tab-@GameType" data-bs-toggle="tab" data-bs-target="#daily-@GameType" type="button" role="tab">Daily Rewards</button>
            </li>
        </ul>
        <div class="tab-content p-3 border border-top-0" id="economyTabsContent-@GameType">
            <!-- Onboarding -->
            <div class="tab-pane fade show active" id="onboarding-@GameType" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label">Welcome Bonus (Coins)</label>
                    <input type="number" class="form-control" @bind="EconomyConfig.WelcomeBonus" />
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="EconomyConfig.DailyEnabled" id="dailyEnabled-@GameType">
                    <label class="form-check-label" for="dailyEnabled-@GameType">Enable Daily Rewards System</label>
                </div>
                <button class="btn btn-primary" @onclick="SaveEconomy"><i class="bi bi-save"></i> Save Onboarding</button>
            </div>

            <!-- Daily Rewards -->
            <div class="tab-pane fade" id="daily-@GameType" role="tabpanel">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="DailyConfig.Enabled" id="dailyRewardsEnabled-@GameType">
                    <label class="form-check-label" for="dailyRewardsEnabled-@GameType">Enable Daily Rewards</label>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Jackpot?</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var reward in DailyConfig.Rewards.OrderBy(r => r.Day))
                        {
                            <tr>
                                <td><input type="number" class="form-control form-control-sm" @bind="reward.Day" /></td>
                                <td><input type="number" class="form-control form-control-sm" @bind="reward.Amount" /></td>
                                <td><input type="text" class="form-control form-control-sm" @bind="reward.Type" /></td>
                                <td><input type="checkbox" class="form-check-input" @bind="reward.IsJackpot" /></td>
                                <td><button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveDailyReward(reward)"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>
                <button class="btn btn-outline-secondary mb-3" @onclick="AddDailyReward"><i class="bi bi-plus-lg"></i> Add Day</button>
                <br/>
                <button class="btn btn-primary" @onclick="SaveDaily"><i class="bi bi-save"></i> Save Daily Rewards</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string GameType { get; set; } = "Ludo";

    private GameEconomyConfig EconomyConfig { get; set; } = new();
    private DailyRewardsWrapper DailyConfig { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        EconomyConfig = await AdminService.GetGameEconomyConfigAsync(GameType);
        DailyConfig = await AdminService.GetDailyRewardsConfigAsync(GameType);
    }

    private async Task SaveEconomy()
    {
        await AdminService.SaveGameEconomyConfigAsync(GameType, EconomyConfig);
    }

    private async Task SaveDaily()
    {
        var days = DailyConfig.Rewards.Select(r => r.Day).OrderBy(d => d).ToList();
        for (int i = 0; i < days.Count; i++)
        {
            if (days[i] != i + 1)
            {
                Toast.ShowError($"Missing Day {i + 1}. Days must be consecutive starting from 1.");
                return;
            }
        }
        await AdminService.SaveDailyRewardsConfigAsync(GameType, DailyConfig);
        Toast.ShowSuccess("Daily rewards saved");
    }

    private void AddDailyReward()
    {
        var nextDay = DailyConfig.Rewards.Any() ? DailyConfig.Rewards.Max(r => r.Day) + 1 : 1;
        DailyConfig.Rewards.Add(new DailyRewardConfig { Day = nextDay, Amount = 100 });
    }

    private void RemoveDailyReward(DailyRewardConfig reward)
    {
        DailyConfig.Rewards.Remove(reward);
    }
}