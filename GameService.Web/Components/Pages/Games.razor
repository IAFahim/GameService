@page "/games"
@using GameService.GameCore
@attribute [Authorize]
@rendermode InteractiveServer
@inject GameAdminService AdminService

<PageTitle>Active Games</PageTitle>

<div class="container-fluid">
    <PageHeader Title="Active Games" Subtitle="Monitor live rooms and jump in to manage them">
        <Actions>
            <div class="input-group" style="max-width: 320px;">
                <span class="input-group-text bg-white"><i class="bi bi-filter"></i></span>
                <input class="form-control" placeholder="Filter by Room ID / Type" aria-label="Filter games" @bind="filter" />
            </div>
            <button class="btn btn-outline-secondary" @onclick="LoadGames">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </Actions>
    </PageHeader>

    @if (games == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else if (FilteredRooms.Any())
    {
        <div class="list-group shadow-sm">
            @foreach (var game in FilteredRooms)
            {
                <div class="list-group-item list-group-item-action p-3">
                    <div class="d-flex w-100 justify-content-between align-items-center gap-3 flex-wrap">
                        <div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="badge bg-info">@game.GameType</span>
                                <span class="small text-muted">Room</span>
                                <span class="font-monospace fw-bold">@game.RoomId</span>
                            </div>
                            <div class="small text-muted mt-1">
                                <i class="bi bi-people-fill"></i> @game.PlayerCount / @game.MaxPlayers players
                                <span class="mx-2">â€¢</span>
                                @(game.IsPublic ? "Public" : "Private")
                            </div>
                        </div>
                        <a href="games/@game.RoomId" class="btn btn-primary">
                            Manage <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-1"></i>
            <p class="mt-3 mb-0">No active games.</p>
            <div class="mt-3">
                <a href="catalog" class="btn btn-outline-primary">Go to Catalog</a>
            </div>
        </div>
    }
</div>

@code {
    private List<GameRoomDto>? games;
    private string filter = "";

    private IEnumerable<GameRoomDto> FilteredRooms =>
        games?.Where(g =>
            string.IsNullOrWhiteSpace(filter) ||
            g.RoomId.Contains(filter, StringComparison.OrdinalIgnoreCase) ||
            g.GameType.Contains(filter, StringComparison.OrdinalIgnoreCase))
        ?? Enumerable.Empty<GameRoomDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadGames();
    }

    private async Task LoadGames()
    {
        games = await AdminService.GetActiveGamesAsync();
    }

}
